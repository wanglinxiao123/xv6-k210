# 结构体
```C
struct buf
{
    int valid;             // 是否有数据从磁盘读入
    int disk;              // 是否有磁盘占有该 buf
    uint dev;              // 磁盘设备号
    uint sectorno;         // 要读/写的磁盘扇区号
    struct sleeplock lock; // 睡眠锁
    uint refcnt;           // 引用计数
    struct buf *prev;
    struct buf *next;
    uchar data[BSIZE]; // 数据缓冲区
};

struct
{
    struct spinlock lock;
    struct buf buf[NBUF];
    struct buf head; // 磁盘缓冲块头
} bcache;
```

# 函数
```C
// 构建双向环形链表，初始化每一个buf的睡眠锁
void binit(void)

// 如果扇区已经被缓存，就直接返回
// 如果没有被缓存，就通过 LRU 选择一个缓存块返回
static struct buf *bget(uint dev, uint sectorno)

// 获取对应的扇区缓存
// 如果缓存中没有数据，就将扇区的数据读取到缓存中
struct buf *bread(uint dev, uint sectorno)

// 将缓存 b 的数据写入磁盘
void bwrite(struct buf *b)

// 引用计数--，如果为0，则回收缓存块
void brelse(struct buf *b)

// 引用计数++
void bpin(struct buf *b)

// 引用计数--
void bunpin(struct buf *b)
```
